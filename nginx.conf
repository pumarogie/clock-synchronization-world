# ═══════════════════════════════════════════════════════════════════════════
# NGINX CONFIGURATION FOR SCALABLE VIDEO SYNC
# ═══════════════════════════════════════════════════════════════════════════
#
# This configuration provides:
# - Load balancing across multiple Node.js instances
# - Sticky sessions (required for WebSocket connections)
# - WebSocket upgrade handling
# - SSL termination (for production)
# - Connection limiting and rate limiting
#
# Usage:
#   1. Copy to /etc/nginx/conf.d/sync-server.conf
#   2. Adjust upstream servers to match your deployment
#   3. Add SSL certificates for production
#   4. nginx -t && systemctl reload nginx
#
# ═══════════════════════════════════════════════════════════════════════════

# ═══════════════════════════════════════════════════════════════════════════
# UPSTREAM CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════

# Define the upstream servers (Node.js instances)
upstream sync_servers {
    # IP hash for sticky sessions - ensures WebSocket connections
    # always go to the same backend server
    ip_hash;
    
    # Server instances (adjust ports/hosts for your setup)
    server 127.0.0.1:3001 weight=1 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:3002 weight=1 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:3003 weight=1 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:3004 weight=1 max_fails=3 fail_timeout=30s;
    
    # For Docker/Kubernetes deployments:
    # server app:3000 weight=1;
    # server app-replica-1:3000 weight=1;
    # server app-replica-2:3000 weight=1;
    
    # Keep connections alive for better performance
    keepalive 64;
}

# ═══════════════════════════════════════════════════════════════════════════
# RATE LIMITING ZONES
# ═══════════════════════════════════════════════════════════════════════════

# Connection limiting by IP
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

# Request rate limiting by IP
limit_req_zone $binary_remote_addr zone=req_limit:10m rate=100r/s;

# WebSocket connection limiting
limit_conn_zone $binary_remote_addr zone=ws_conn_limit:10m;

# ═══════════════════════════════════════════════════════════════════════════
# CACHING
# ═══════════════════════════════════════════════════════════════════════════

# Proxy cache for static assets
proxy_cache_path /var/cache/nginx/sync_cache 
    levels=1:2 
    keys_zone=sync_cache:10m 
    max_size=1g 
    inactive=60m 
    use_temp_path=off;

# ═══════════════════════════════════════════════════════════════════════════
# MAIN SERVER BLOCK (HTTP - redirect to HTTPS in production)
# ═══════════════════════════════════════════════════════════════════════════

server {
    listen 80;
    listen [::]:80;
    server_name sync.example.com;
    
    # For local development, serve directly
    # For production, uncomment the redirect below
    # return 301 https://$server_name$request_uri;
    
    # Include the main location blocks
    include /etc/nginx/snippets/sync-locations.conf;
}

# ═══════════════════════════════════════════════════════════════════════════
# HTTPS SERVER BLOCK (Production)
# ═══════════════════════════════════════════════════════════════════════════

# Uncomment for production with SSL
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name sync.example.com;
#     
#     # SSL Configuration
#     ssl_certificate /etc/letsencrypt/live/sync.example.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/sync.example.com/privkey.pem;
#     ssl_session_timeout 1d;
#     ssl_session_cache shared:SSL:50m;
#     ssl_session_tickets off;
#     
#     # Modern SSL configuration
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
#     ssl_prefer_server_ciphers off;
#     
#     # HSTS
#     add_header Strict-Transport-Security "max-age=63072000" always;
#     
#     # Include the main location blocks
#     include /etc/nginx/snippets/sync-locations.conf;
# }

# ═══════════════════════════════════════════════════════════════════════════
# LOCATION BLOCKS (save as /etc/nginx/snippets/sync-locations.conf)
# ═══════════════════════════════════════════════════════════════════════════

# Or include these directly in server blocks above:

# Root location - proxy to upstream
location / {
    # Rate limiting
    limit_req zone=req_limit burst=50 nodelay;
    limit_conn conn_limit 50;
    
    # Proxy settings
    proxy_pass http://sync_servers;
    proxy_http_version 1.1;
    
    # Headers for proper proxying
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Connection keep-alive
    proxy_set_header Connection "";
    
    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # Buffer settings
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
}

# WebSocket endpoint - special handling
location /socket.io/ {
    # WebSocket connection limit
    limit_conn ws_conn_limit 10;
    
    # Proxy settings
    proxy_pass http://sync_servers;
    proxy_http_version 1.1;
    
    # WebSocket upgrade headers
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # Standard proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Longer timeouts for WebSocket
    proxy_connect_timeout 7d;
    proxy_send_timeout 7d;
    proxy_read_timeout 7d;
    
    # Disable buffering for WebSocket
    proxy_buffering off;
    
    # Cache bypass for WebSocket
    proxy_cache_bypass $http_upgrade;
}

# Static assets - with caching
location /_next/static/ {
    proxy_pass http://sync_servers;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    
    # Cache static assets
    proxy_cache sync_cache;
    proxy_cache_valid 200 60m;
    proxy_cache_valid 404 1m;
    
    # Cache headers
    add_header X-Cache-Status $upstream_cache_status;
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# Health check endpoint
location /health {
    access_log off;
    proxy_pass http://sync_servers;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
}

# Nginx status (for monitoring)
location /nginx_status {
    stub_status on;
    access_log off;
    allow 127.0.0.1;
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    deny all;
}

